{% extends 'products/base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - BizPrint{% endblock %}

{% block content %}
<style>
  .analytics-container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 2rem;
  }

  .analytics-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .analytics-header h1 {
    font-size: 2.5rem;
    color: #1d3557;
    margin-bottom: 0.5rem;
  }

  .analytics-header p {
    color: #666;
    font-size: 1.1rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-left: 4px solid #1d3557;
    transition: transform 0.2s;
  }

  .stat-card:hover {
    transform: translateY(-3px);
  }

  .stat-card.accent-red {
    border-left-color: #e63946;
  }

  .stat-card.accent-blue {
    border-left-color: #457b9d;
  }

  .stat-card.accent-green {
    border-left-color: #2a9d8f;
  }

  .stat-label {
    font-size: 0.9rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1d3557;
  }

  .stat-subtext {
    font-size: 0.85rem;
    color: #888;
    margin-top: 0.5rem;
  }

  .chart-section {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f0f0f0;
  }

  .chart-title {
    font-size: 1.5rem;
    color: #1d3557;
    font-weight: 600;
  }

  .chart-subtitle {
    color: #888;
    font-size: 0.9rem;
  }

  .chart-canvas {
    width: 100%;
    max-height: 400px;
  }

  .popular-products {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .product-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
  }

  .product-item:last-child {
    border-bottom: none;
  }

  .product-name {
    font-weight: 600;
    color: #1d3557;
  }

  .product-stats {
    display: flex;
    gap: 2rem;
    color: #666;
    font-size: 0.9rem;
  }

  .product-stat {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }

  .product-stat-label {
    font-size: 0.75rem;
    color: #888;
    text-transform: uppercase;
  }

  .product-stat-value {
    font-weight: 600;
    color: #e63946;
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }

    .product-stats {
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .analytics-header h1 {
      font-size: 2rem;
    }
  }
</style>

<div class="analytics-container">
  <div class="analytics-header">
    <h1>ðŸ“Š Your Analytics Dashboard</h1>
    <p>Track your spending, orders, and savings over time</p>
  </div>

  <!-- Key Statistics -->
  <div class="stats-grid">
    <div class="stat-card accent-blue">
      <div class="stat-label">Total Orders</div>
      <div class="stat-value">{{ analytics.total_orders }}</div>
      <div class="stat-subtext">All-time orders placed</div>
    </div>

    <div class="stat-card accent-red">
      <div class="stat-value">R{{ analytics.total_all_spending|floatformat:2 }}</div>
      <div class="stat-label">Total Spending</div>
      <div class="stat-subtext">Print + Design Services</div>
    </div>

    <div class="stat-card accent-green">
      <div class="stat-label">Average Order</div>
      <div class="stat-value">R{{ analytics.avg_order_value|floatformat:2 }}</div>
      <div class="stat-subtext">Per order value</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Total Savings</div>
      <div class="stat-value">R{{ analytics.total_discounts|floatformat:2 }}</div>
      <div class="stat-subtext">From discount codes</div>
    </div>
  </div>

  <!-- Monthly Spending Chart -->
  <div class="chart-section">
    <div class="chart-header">
      <div>
        <div class="chart-title">Monthly Spending Trend</div>
        <div class="chart-subtitle">Last 12 months</div>
      </div>
    </div>
    <canvas id="monthlySpendingChart" class="chart-canvas"></canvas>
  </div>

  <!-- Order Status Breakdown -->
  <div class="chart-section">
    <div class="chart-header">
      <div>
        <div class="chart-title">Order Status Distribution</div>
        <div class="chart-subtitle">Current status of all orders</div>
      </div>
    </div>
    <canvas id="statusChart" class="chart-canvas" style="max-height: 300px;"></canvas>
  </div>

  <!-- Popular Products -->
  <div class="popular-products">
    <div class="chart-header">
      <div>
        <div class="chart-title">Your Top Products</div>
        <div class="chart-subtitle">Most frequently ordered</div>
      </div>
    </div>
    
    {% if analytics.popular_products %}
      {% for product in analytics.popular_products %}
        <div class="product-item">
          <div class="product-name">{{ product.product__name }}</div>
          <div class="product-stats">
            <div class="product-stat">
              <span class="product-stat-label">Orders</span>
              <span class="product-stat-value">{{ product.count }}</span>
            </div>
            <div class="product-stat">
              <span class="product-stat-label">Total Spent</span>
              <span class="product-stat-value">R{{ product.total_spent|floatformat:2 }}</span>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p style="text-align: center; color: #888; padding: 2rem;">No orders yet. Start shopping to see your analytics!</p>
    {% endif %}
  </div>

  <!-- Design Services Summary -->
  {% if analytics.total_design_requests > 0 %}
  <div class="chart-section" style="margin-top: 2rem;">
    <div class="chart-header">
      <div>
        <div class="chart-title">Design Services</div>
        <div class="chart-subtitle">Your custom design projects</div>
      </div>
    </div>
    <div class="stats-grid" style="margin: 0;">
      <div class="stat-card accent-blue">
        <div class="stat-label">Total Projects</div>
        <div class="stat-value">{{ analytics.total_design_requests }}</div>
      </div>
      <div class="stat-card accent-red">
        <div class="stat-label">Design Spending</div>
        <div class="stat-value">R{{ analytics.design_spending|floatformat:2 }}</div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Monthly Spending Chart
  const monthlyCtx = document.getElementById('monthlySpendingChart').getContext('2d');
  new Chart(monthlyCtx, {
    type: 'line',
    data: {
      labels: {{ analytics.monthly_data.labels|safe }},
      datasets: [{
        label: 'Spending (R)',
        data: {{ analytics.monthly_data.spending|safe }},
        borderColor: '#e63946',
        backgroundColor: 'rgba(230, 57, 70, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }, {
        label: 'Orders',
        data: {{ analytics.monthly_data.orders|safe }},
        borderColor: '#1d3557',
        backgroundColor: 'rgba(29, 53, 87, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          title: {
            display: true,
            text: 'Spending (R)'
          }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          title: {
            display: true,
            text: 'Number of Orders'
          },
          grid: {
            drawOnChartArea: false
          }
        }
      }
    }
  });

  // Order Status Chart
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  const statusData = {{ analytics.status_breakdown|safe }};
  
  new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(statusData).map(s => s.replace('_', ' ').toUpperCase()),
      datasets: [{
        data: Object.values(statusData),
        backgroundColor: [
          '#1d3557',
          '#457b9d',
          '#2a9d8f',
          '#e63946',
          '#f77f00',
          '#d62828'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right'
        }
      }
    }
  });
</script>
{% endblock %}
