{% extends 'products/base.html' %}

{% block title %}Order Summary - BizPrint{% endblock %}

{% block content %}
<div class="container">

  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-error{% else %}alert-success{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  {% if order %}
    <div class="order-summary-card">
      <div class="summary-header">
        <h1 class="" >Order Summary</h1>
        <span class="order-status-badge status-{{ order.status }}">{{ order.get_status_display }}</span>
      </div>

      <div class="summary-section">
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Reference</span>
            <span class="info-value">{{ order.uuid }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Product</span>
            <span class="info-value">{{ order.product.name }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Quantity</span>
            <span class="info-value">{{ order.quantity }} units</span>
          </div>
          <div class="info-item">
            <span class="info-label">Submitted</span>
            <span class="info-value">{{ order.created_at|date:"M d, Y - g:i a" }}</span>
          </div>
        </div>
      </div>

      {% if order.options %}
      <div class="summary-section">
        <h3 class="section-title">Configuration</h3>
        <div class="options-grid">
          {% for k, v in order.options.items %}
            <div class="option-item">
              <span class="option-label">{{ k }}</span>
              <span class="option-value">{{ v }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if order.services %}
      <div class="summary-section">
        <h3 class="section-title">Additional Services</h3>
        <div class="services-list">
          {% for s in order.services %}
            <span class="service-tag">{{ s }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="summary-section pricing-section">
        <h3 class="section-title">Pricing Breakdown</h3>
        <div class="pricing-details">
          <div class="price-row">
            <span>Subtotal</span>
            <span>R{{ subtotal|floatformat:2 }}</span>
          </div>
          {% if order.shipping_price %}
          <div class="price-row">
            <span>Shipping</span>
            <span>R{{ order.shipping_price|floatformat:2 }}</span>
          </div>
          {% endif %}
          <div class="price-row">
            <span>VAT (15%)</span>
            <span>R{{ vat|floatformat:2 }}</span>
          </div>
          <div class="price-row total-row">
            <span>Total</span>
            <span>R{{ order.total_price|floatformat:2 }}</span>
          </div>
        </div>
        <div class="payment-status-indicator payment-{{ order.payment_status }}">
          {% if order.payment_status == 'paid' %}
            ‚úì Payment Verified
          {% else %}
            ‚è≥ Payment {{ order.get_payment_status_display }}
          {% endif %}
        </div>
      </div>

      {% if order.status != "cancelled" and order.status != "refunded" %}
        <!-- üöö Visual Order Timeline -->
        <div class="timeline-container">
            <div class="timeline-step active">
                <div class="circle">‚úì</div>
                <div class="label">Order Placed</div>
            </div>
            
            <div class="timeline-step {% if order.payment_status == 'paid' or order.status in 'in_production shipped completed' %}active{% endif %}">
                <div class="circle">{% if order.payment_status == 'paid' or order.status in 'in_production shipped completed' %}‚úì{% else %}2{% endif %}</div>
                <div class="label">Payment Verified</div>
            </div>

            <div class="timeline-step {% if order.status in 'in_production shipped completed' %}active{% endif %}">
                <div class="circle">{% if order.status in 'in_production shipped completed' %}‚úì{% else %}3{% endif %}</div>
                <div class="label">In Production</div>
            </div>

            <div class="timeline-step {% if order.status in 'shipped completed' %}active{% endif %}">
                <div class="circle">{% if order.status in 'shipped completed' %}‚úì{% else %}4{% endif %}</div>
                <div class="label">Ready / Shipped</div>
            </div>

            <div class="timeline-step {% if order.status == 'completed' %}active{% endif %}">
                <div class="circle">{% if order.status == 'completed' %}‚úì{% else %}5{% endif %}</div>
                <div class="label">Completed</div>
            </div>
        </div>
      {% endif %}

    {% if order.payment_status == "pending" %}
      <div class="alert alert-warning mt-2">
        <p><strong>Next Step:</strong> Please make payment via EFT:</p>
        <p>
          <strong>Bank:</strong> FNB<br>
          <strong>Account Name:</strong> BizPrint (Pty) Ltd<br>
          <strong>Account Number:</strong> 123456789<br>
          <strong>Reference:</strong> {{ order.uuid }}
        </p>

        {# ---- Proof of payment UX (pure Django template) ---- #}
        {% if order.proof_of_payment %}
          <div class="alert alert-success" style="margin-top: 1rem;">
            ‚úÖ We‚Äôve received your proof of payment. We‚Äôll verify it shortly.
            {% if order.proof_of_payment.url %}
              <div style="margin-top: .5rem;">
                <a href="{{ order.proof_of_payment.url }}" target="_blank" rel="noopener">View uploaded file</a>
                {% if order.proof_of_payment.size %} ‚Ä¢ {{ order.proof_of_payment.size|filesizeformat }}{% endif %}
              </div>
            {% endif %}
          </div>

          {# Re-upload form (always visible, no JS) #}
          <form method="post"
                action="{% url 'products:upload_payment_proof' order_id=order.uuid %}"
                enctype="multipart/form-data"
                class="upload-form">
            {% csrf_token %}
            <div class="upload-box">
              <label class="upload-label">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <span>Re-upload Proof of Payment</span>
                <small>PDF, PNG, JPG ‚Äì Max 5MB</small>
                <input type="file" name="payment_file" accept=".pdf,.png,.jpg,.jpeg" required class="file-input">
              </label>
            </div>
            <button type="submit" class="btn btn-primary">üì§ Submit New Proof</button>
          </form>
        {% else %}
          <form method="post"
                action="{% url 'products:upload_payment_proof' order_id=order.uuid %}"
                enctype="multipart/form-data"
                class="upload-form">
            {% csrf_token %}
            <div class="upload-box">
              <label class="upload-label">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <span>Upload Proof of Payment</span>
                <small>PDF, PNG, JPG ‚Äì Max 5MB</small>
                <input type="file" name="payment_file" accept=".pdf,.png,.jpg,.jpeg" required class="file-input">
              </label>
            </div>
            <button type="submit" class="btn btn-primary">üì§ Submit Proof</button>
          </form>
        {% endif %}
      </div>
    {% elif order.payment_status == "paid" %}
      <div class="alert alert-success">‚úÖ Payment received and verified.</div>
    {% endif %}

    </div>

    {% if order.file %}
      <div class="artwork-card">
        <h3 class="section-title">üìé Artwork</h3>
        <div class="artwork-preview">
          {% if ".jpg" in order.file.name|lower or ".jpeg" in order.file.name|lower or ".png" in order.file.name|lower %}
            <img src="{{ order.file.url }}" alt="Uploaded artwork" class="artwork-image">
          {% else %}
            <div class="file-indicator">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                <polyline points="13 2 13 9 20 9"/>
              </svg>
              <p>{{ order.file.name }}</p>
            </div>
          {% endif %}
        </div>

        <form action="{% url 'products:reupload_artwork' order.uuid %}" method="post" enctype="multipart/form-data" class="upload-form">
          {% csrf_token %}
          <div class="upload-box">
            <label class="upload-label">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <span>Replace Artwork File</span>
              <small>PDF, PNG, JPG ‚Äì Max 5MB</small>
              <input type="file" name="file" accept=".pdf,.png,.jpg,.jpeg" required class="file-input">
            </label>
          </div>
          <button type="submit" class="btn btn-primary">üîÑ Update Artwork</button>
        </form>
      </div>
    {% endif %}

    <div class="action-buttons">
      <a href="{% url 'products:order_invoice' order.uuid %}" target="_blank" class="btn btn-primary">üßæ View Invoice</a>
      <a href="{% url 'products:track_order' %}" class="btn btn-outline">Track Another Order</a>
      {% if order.status == 'received' %}
        <form method="post" action="{% url 'products:cancel_order' order.uuid %}" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to cancel this order?')">Cancel Order</button>
        </form>
      {% endif %}
    </div>

  {% else %}
    <div class="alert alert-error">
      No order found for the reference you entered.
    </div>
  {% endif %}

</div>

<style>
  /* Card Layout */
  .order-summary-card,
  .artwork-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
    overflow: hidden;
  }

  .summary-header {
    background: #1d3557;
    padding: 2rem;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .summary-header h1 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    color: white;
  }

  .order-status-badge {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    padding: 0.5rem 1.25rem;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .status-completed { background: rgba(40, 167, 69, 0.3); }
  .status-in_production { background: rgba(255, 193, 7, 0.3); }
  .status-shipped { background: rgba(0, 123, 255, 0.3); }

  .summary-section {
    padding: 2rem;
    border-bottom: 1px solid #f0f0f0;
  }

  .summary-section:last-child {
    border-bottom: none;
  }

  .section-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1d3557;
    margin: 0 0 1.25rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Info Grid */
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
  }

  .info-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .info-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    font-weight: 600;
  }

  .info-value {
    font-size: 1rem;
    color: #1d3557;
    font-weight: 600;
  }

  /* Options Grid */
  .options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }

  .option-item {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 3px solid #1d3557;
  }

  .option-label {
    display: block;
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0.4rem;
    font-weight: 600;
  }

  .option-value {
    display: block;
    color: #1d3557;
    font-weight: 600;
  }

  /* Services List */
  .services-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .service-tag {
    background: #e8f5e9;
    color: #2e7d32;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    border: 1px solid #a5d6a7;
  }

  /* Pricing Section */
  .pricing-section {
    background: #fafafa;
  }

  .pricing-details {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .price-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    font-size: 0.95rem;
    color: #333;
  }

  .price-row:not(:last-child) {
    border-bottom: 1px solid #f0f0f0;
  }

  .total-row {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1d3557;
    margin-top: 0.5rem;
    padding-top: 1rem;
    border-top: 2px solid #1d3557 !important;
  }

  .payment-status-indicator {
    margin-top: 1.25rem;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .payment-paid {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .payment-pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }

  /* Upload Forms */
  .upload-form {
    margin-top: 1.5rem;
  }

  .upload-box {
    margin-bottom: 1rem;
  }

  .upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    border: 2px dashed #d0d0d0;
    border-radius: 10px;
    background: #fafafa;
    cursor: pointer;
    transition: all 0.3s;
    gap: 0.75rem;
  }

  .upload-label:hover {
    border-color: #1d3557;
    background: #f5f8fa;
  }

  .upload-label svg {
    color: #6c757d;
  }

  .upload-label span {
    font-weight: 600;
    color: #1d3557;
    font-size: 1rem;
  }

  .upload-label small {
    color: #6c757d;
    font-size: 0.85rem;
  }

  .file-input {
    display: none;
  }

  /* Artwork Section */
  .artwork-card {
    padding: 2rem;
  }

  .artwork-preview {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .artwork-image {
    max-width: 100%;
    max-height: 400px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .file-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    color: #6c757d;
  }

  .file-indicator svg {
    stroke: #1d3557;
  }

  .file-indicator p {
    font-weight: 600;
    color: #1d3557;
    margin: 0;
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 2rem;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    cursor: pointer;
    font-size: 0.95rem;
    line-height: 1;
  }

  .btn-primary {
    background: #1d3557;
    color: white;
    border: 2px solid #1d3557;
  }

  .btn-primary:hover {
    background: #457b9d;
    border-color: #457b9d;
  }

  .btn-outline {
    background: white;
    color: #1d3557;
    border: 2px solid #1d3557;
  }

  .btn-outline:hover {
    background: #1d3557;
    color: white;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
    transform: translateY(-1px);
  }

  /* Alerts */
  .alert {
    padding: 1.25rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border: 1px solid transparent;
  }

  .alert-warning {
    background: #fff3cd;
    color: #856404;
    border-color: #ffeaa7;
  }

  .alert-success {
    background: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
  }

  .alert-error {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
  }

  .alert strong {
    display: block;
    margin-bottom: 0.5rem;
  }

  @media (max-width: 768px) {
    .summary-header {
      padding: 1.5rem;
    }

    .summary-header h1 {
      font-size: 1.5rem;
    }

    .summary-section {
      padding: 1.5rem;
    }

    .info-grid {
      grid-template-columns: 1fr;
    }

    .action-buttons {
      flex-direction: column;
    }

    .btn {
      width: 100%;
      text-align: center;
    }
  }

  /* Timeline CSS */
  .timeline-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 2rem 0;
    position: relative;
  }

  .timeline-container::before {
    content: '';
    position: absolute;
    top: 15px;
    left: 0;
    right: 0;
    height: 3px;
    background: #e0e0e0;
    z-index: 0;
  }

  .timeline-step {
    position: relative;
    z-index: 1;
    text-align: center;
    flex: 1;
  }

  .timeline-step .circle {
    width: 35px;
    height: 35px;
    background: #fff;
    border: 3px solid #e0e0e0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: bold;
    color: #999;
    transition: all 0.3s ease;
  }

  .timeline-step .label {
    font-size: 0.85rem;
    color: #999;
    font-weight: 500;
  }

  /* Active State */
  .timeline-step.active .circle {
    background: #25D366; /* WhatsApp Green for consistency */
    border-color: #25D366;
    color: #fff;
  }

  .timeline-step.active .label {
    color: #1d3557;
    font-weight: bold;
  }

  /* Connecting Line Progress */
  /* This is a simple trick: we color the line based on how many items are active. 
     For a perfect CSS-only progress bar, we'd need a separate bar element, 
     but this visual is usually sufficient for simple trackers. */
  
  @media (max-width: 600px) {
    .timeline-step .label {
        font-size: 0.7rem;
    }
    .timeline-step .circle {
        width: 25px;
        height: 25px;
        font-size: 0.8rem;
    }
  }
</style>
{% endblock %}
