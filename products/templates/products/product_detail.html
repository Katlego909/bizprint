{% extends 'products/base.html' %}

{% block title %}{{ product.name }} - BizPrint{% endblock %}

{% block extra_head %}
<style>
  /* Reusing the clean form styles */
  .form-section {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    margin-bottom: 2rem;
  }
  .form-section h3 {
    margin-top: 0;
    color: #1d3557;
    border-bottom: 2px solid #f1f1f1;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 1.2rem;
  }

  .product-header {
    display: flex;
    flex-wrap: wrap;
    align-items: start;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .product-image {
    flex: 1 1 300px;
    max-width: 400px;
  }

  .product-image img {
    width: 100%;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .product-info {
    flex: 2;
  }

  .product-info h1 {
    margin-top: 0;
    color: #1d3557;
    font-size: 2.5rem;
  }

  .product-info .description {
    color: #555;
    font-size: 1.1rem;
    line-height: 1.6;
  }

  /* Form Controls */
  .form-group {
    margin-bottom: 1.5rem;
  }
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
  }
  .form-control {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.3s;
    background: #fff;
  }
  .form-control:focus {
    border-color: #1d3557;
    outline: none;
  }

  /* Checkbox Group */
  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.8rem;
    border: 1px solid #eee;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .checkbox-group label:hover {
    background: #f9f9f9;
  }
  .checkbox-group input[type="checkbox"] {
    transform: scale(1.2);
  }

  /* Sticky Footer */
  .sticky-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: white;
    border-top: 1px solid #ddd;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    z-index: 1000;
    transform: translateY(100%);
    transition: transform 0.3s ease;
  }
  .sticky-footer.visible {
    transform: translateY(0);
  }
  
  .total-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.2rem;
  }
  .total-amount {
    font-size: 1.5rem;
    font-weight: bold;
    color: #1d3557;
  }

  .main-container {
    padding-bottom: 100px;
  }

  @media (max-width: 768px) {
    .product-header {
      flex-direction: column;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container main-container">

  <!-- ðŸ”¥ Product Info Preview -->
  <div class="product-header">
    <div class="product-image">
      <img src="{{ product.image.url }}" alt="{{ product.name }}">
    </div>
    <div class="product-info">
      <h1>{{ product.name }}</h1>
      <p class="description">{{ product.description|linebreaks }}</p>
    </div>
  </div>

  <!-- ðŸ’¼ Order Form -->
  <form method="post" enctype="multipart/form-data" id="order-form">
    {% csrf_token %}

    <!-- Section 1: Configuration -->
    <div class="form-section">
      <h3>1. Configure Your Product</h3>
      
      <div class="form-group">
        <label for="quantity-select">Quantity</label>
        <select name="quantity" id="quantity-select" class="form-control" required>
          <option value="">-- Select Quantity --</option>
          {% for q in quantities %}
            <option value="{{ q.quantity }}" data-baseprice="{{ q.base_price }}">
              {{ q.quantity }} units (R{{ q.base_price }})
            </option>
          {% endfor %}
        </select>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
        {% for option_type, options in grouped_options.items %}
          <div class="form-group">
            <label>{{ option_type }}</label>
            <select name="{{ option_type }}" class="option-select form-control" required>
              <option value="">-- Select {{ option_type }} --</option>
              {% for opt in options %}
                <option value="{{ opt.value }}" data-price="{{ opt.price_modifier }}">
                  {{ opt.value }}{% if opt.price_modifier > 0 %} (+R{{ opt.price_modifier }}){% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endfor %}
      </div>

      {% if services %}
        <div class="form-group checkbox-group">
          <label style="margin-bottom: 0.5rem; border: none; padding: 0;">Optional Extras</label>
          {% for service in services %}
            <label>
              <input type="checkbox" name="{{ service.label }}" class="service-check" data-price="{{ service.price }}">
              <span>{{ service.label }} {% if service.price > 0 %}<strong style="color: #e63946;">(+R{{ service.price }})</strong>{% endif %}</span>
            </label>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Section 2: Shipping & Upload -->
    <div class="form-section">
      <h3>2. Shipping & Artwork</h3>
      
      <div class="form-group">
        <label for="shipping-method">Shipping Method</label>
        <select name="shipping_method" id="shipping-method" class="form-control" required>
          <option value="">-- Select Shipping Option --</option>
          {% for method in shipping_methods %}
            <option value="{{ method.slug }}" data-price="{{ method.price }}">
              {{ method.name }} (R{{ method.price }})
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>Upload Artwork (PDF, PNG, JPG)</label>
        <div style="border: 2px dashed #ccc; padding: 2rem; text-align: center; border-radius: 6px; background: #fafafa;">
            <input type="file" name="file" id="id_file" accept=".pdf,.png,.jpg" required style="display: none;" onchange="showFileName(this)">
            <label for="id_file" class="btn btn-secondary" style="cursor: pointer; margin: 0;">Choose File</label>
            <p id="file-name" style="margin-top: 1rem; color: #666; font-size: 0.9rem;">No file selected</p>
        </div>
      </div>
    </div>

    <!-- Section 3: Delivery Details -->
    <div class="form-section">
      <h3>3. Delivery Details</h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" name="full_name" class="form-control" value="{{ user.first_name }} {{ user.last_name }}" required>
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <div class="form-group">
          <label>Contact Phone</label>
          <input type="text" name="phone" class="form-control" value="{{ user.profile.phone|default:'' }}" required placeholder="e.g. 082 123 4567">
        </div>
        <div class="form-group">
          <label>Discount Code</label>
          <input type="text" name="discount_code" class="form-control" placeholder="Enter code (optional)">
        </div>
      </div>

      <div class="form-group">
        <label>Shipping Address</label>
        <textarea name="address" rows="3" class="form-control" required placeholder="Street address, Suburb, City, Postal Code">{{ user.profile.address|default:'' }}</textarea>
      </div>
    </div>

    <!-- Sticky Footer -->
    <div class="sticky-footer" id="sticky-footer">
      <div>
        <div class="total-label">Total (incl. VAT)</div>
        <div class="total-amount">R<span id="total-price">0.00</span></div>
      </div>
      <button type="submit" class="btn btn-primary" style="padding: 0.8rem 2.5rem; font-size: 1.1rem;">Place Order</button>
    </div>

  </form>

</div>

<script>
  const quantitySelect = document.getElementById("quantity-select");
  const optionSelects = document.querySelectorAll(".option-select");
  const serviceChecks = document.querySelectorAll(".service-check");
  const shippingSelect = document.getElementById("shipping-method");
  const totalPriceEl = document.getElementById("total-price");
  const stickyFooter = document.getElementById("sticky-footer");

  function showFileName(input) {
    const nameDisplay = document.getElementById('file-name');
    if (input.files && input.files.length > 0) {
      nameDisplay.textContent = "Selected: " + input.files[0].name;
      nameDisplay.style.color = "#1d3557";
      nameDisplay.style.fontWeight = "bold";
    } else {
      nameDisplay.textContent = "No file selected";
      nameDisplay.style.color = "#666";
      nameDisplay.style.fontWeight = "normal";
    }
  }

  function updateTotal() {
    const basePrice = parseFloat(quantitySelect.selectedOptions[0]?.dataset.baseprice || 0);
    let modifiers = 0;

    optionSelects.forEach(select => {
      const price = parseFloat(select.selectedOptions[0]?.dataset.price || 0);
      modifiers += !isNaN(price) ? price : 0;
    });

    serviceChecks.forEach(chk => {
      if (chk.checked) {
        const price = parseFloat(chk.dataset.price || 0);
        modifiers += !isNaN(price) ? price : 0;
      }
    });

    const shipping = parseFloat(shippingSelect.selectedOptions[0]?.dataset.price || 0);

    const subtotal = basePrice + modifiers + shipping;
    const tax = subtotal * 0.15;
    const total = subtotal + tax;

    totalPriceEl.textContent = total.toFixed(2);

    // Show footer if a quantity is selected (meaning a price exists)
    if (basePrice > 0) {
      stickyFooter.classList.add('visible');
    } else {
      stickyFooter.classList.remove('visible');
    }
  }

  quantitySelect.addEventListener("change", updateTotal);
  optionSelects.forEach(s => s.addEventListener("change", updateTotal));
  serviceChecks.forEach(c => c.addEventListener("change", updateTotal));
  shippingSelect.addEventListener("change", updateTotal);
</script>

{{ pending_data|json_script:"pending-data-json" }}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const pendingDataElement = document.getElementById('pending-data-json');
    if (pendingDataElement) {
      const pendingData = JSON.parse(pendingDataElement.textContent);
      if (pendingData && Object.keys(pendingData).length > 0) {
        // console.log("Restoring pending order data...", pendingData);
        for (const [key, value] of Object.entries(pendingData)) {
          if (key === 'csrfmiddlewaretoken') continue;
          
          // Try to find input by name
          const input = document.querySelector(`[name="${key}"]`);
          if (input) {
            if (input.type === 'checkbox') {
              input.checked = true;
            } else if (input.tagName === 'SELECT') {
                input.value = value;
            } else if (input.type !== 'file') {
                input.value = value;
            }
            // Trigger change event manually to update totals
            input.dispatchEvent(new Event('change'));
          }
        }
      }
    }
  });
</script>
{% endblock %}
