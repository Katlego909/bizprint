{% extends 'products/base.html' %}

{% block title %}Request a Design – BizPrint{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="container main-container" style="max-width: 900px; margin: 3rem auto;">
  
  <div style="text-align: center; margin-bottom: 3rem;">
    <h1 class="section-title" style="margin-bottom: 0.5rem;">Start Your Design Project</h1>
    <p style="color: #666; font-size: 1.1rem;">Select the packages you need, tell us about your vision, and we'll get to work.</p>
  </div>

  <form method="post" enctype="multipart/form-data" id="design-form">
    {% csrf_token %}

    <!-- Step 1: Contact Info -->
    <div class="form-section">
      <h3>1. Contact Details</h3>
      <div class="form-row-grid">
        <div class="form-group">
          <label for="id_fullname">Full Name</label>
          <input type="text" name="full_name" id="id_fullname" class="form-control"
                 value="{% if form_data %}{{ form_data.full_name }}{% elif request.user.is_authenticated %}{{ request.user.first_name }} {{ request.user.last_name }}{% endif %}"
                 placeholder="Your Name" required>
        </div>

        <div class="form-group">
          <label for="id_phone">Phone Number (WhatsApp)</label>
          <input type="text" name="phone" id="id_phone" class="form-control"
                 value="{% if form_data %}{{ form_data.phone }}{% elif request.user.is_authenticated and request.user.profile %}{{ request.user.profile.phone }}{% endif %}"
                 placeholder="e.g. 082 123 4567">
        </div>
      </div>

      {% if not request.user.is_authenticated %}
        <div class="form-group">
          <label for="id_email">Email Address <span style="color: #e63946;">*</span></label>
          <input type="email" name="email" id="id_email" class="form-control"
                 value="{% if form_data %}{{ form_data.email }}{% endif %}"
                 required placeholder="name@example.com">
        </div>
      {% endif %}
    </div>

    <!-- Step 2: Packages -->
    <div class="form-section">
      <h3>2. Select Packages</h3>
      <div class="package-grid">
        {% for package in all_packages %}
          <div class="package-card {% if package in pre_selected_packages %}selected{% endif %}" onclick="toggleCard(this)">
            <div class="package-title">{{ package.title }}</div>
            <input type="checkbox" name="packages" value="{{ package.id }}" data-price="{{ package.price }}"
                   {% if package in pre_selected_packages %}checked{% endif %} onclick="event.stopPropagation(); updateTotal();">
            <div class="package-desc">{{ package.description }}</div>
            <div class="package-price">R{{ package.price|floatformat:0 }}</div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Step 3: Design Brief -->
    <div class="form-section">
      <h3>3. Design Brief</h3>
      <p style="color: #666; margin-bottom: 1.5rem;">Help us understand your vision better</p>
      
      <div class="form-row-grid">
        <div class="form-group">
          <label for="id_brand_colors">Brand Colors</label>
          <input type="text" name="brand_colors" id="id_brand_colors" class="form-control"
                 value="{{ form_data.brand_colors }}"
                 placeholder="e.g., #FF5733, Blue, Red">
          <small style="color: #666;">Hex codes or color names</small>
        </div>

        <div class="form-group">
          <label for="id_timeline">Timeline Preference</label>
          <select name="timeline_preference" id="id_timeline" class="form-control" onchange="updateTotal()">
            <option value="">Select timeline...</option>
            <option value="rush" {% if form_data.timeline_preference == 'rush' %}selected{% endif %}>Rush (1-2 days) - 50% Surcharge ⚡</option>
            <option value="standard" {% if form_data.timeline_preference == 'standard' %}selected{% endif %}>Standard (3-5 days)</option>
            <option value="flexible" {% if form_data.timeline_preference == 'flexible' %}selected{% endif %}>Flexible (1-2 weeks)</option>
          </select>
          <small id="rush-warning" style="color: #e63946; font-weight: bold; display: none; margin-top: 0.5rem;">
            ⚠️ Rush jobs include a 50% surcharge on the total package price
          </small>
        </div>
      </div>

      <div class="form-group">
        <label for="id_target_audience">Target Audience</label>
        <textarea name="target_audience" id="id_target_audience" rows="3" class="form-control"
                  placeholder="Who is your target audience? e.g., Young professionals, Corporate clients, Students...">{{ form_data.target_audience }}</textarea>
      </div>

      <div class="form-group">
        <label for="id_design_preferences">Design Style Preferences</label>
        <textarea name="design_preferences" id="id_design_preferences" rows="3" class="form-control"
                  placeholder="Describe your preferred style: Modern, Classic, Minimalist, Bold, Elegant, etc.">{{ form_data.design_preferences }}</textarea>
      </div>

      <div class="form-group">
        <label for="id_inspiration_links">Inspiration Links (Optional)</label>
        <textarea name="inspiration_links" id="id_inspiration_links" rows="2" class="form-control"
                  placeholder="Paste links to designs you like (one per line)">{{ form_data.inspiration_links }}</textarea>
      </div>

      <div class="form-group">
        <label for="id_instructions">Additional Instructions</label>
        <textarea name="additional_instructions" id="id_instructions" rows="4" class="form-control"
                  placeholder="Any other details we should know?">{{ form_data.additional_instructions }}</textarea>
      </div>

      <div class="form-group">
        <label for="id_upload">Upload References / Logos (Optional)</label>
        <div style="border: 2px dashed #ccc; padding: 2rem; text-align: center; border-radius: 6px; background: #fafafa;">
            <input type="file" name="uploaded_files" id="id_upload"
                   accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.ai,.psd"
                   style="display: none;" onchange="showFilePreview(this)">
            <label for="id_upload" class="btn btn-secondary" style="cursor: pointer;">Choose File</label>
            <div id="file-preview" style="margin-top: 1rem;">
              <p id="file-name" style="color: #666; font-size: 0.9rem;">No file selected</p>
            </div>
            <p style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">Max 5MB. Accepted: PDF, JPG, PNG, AI, PSD</p>
        </div>
      </div>
    </div>

    <!-- Sticky Footer -->
    <div class="sticky-footer" id="sticky-footer">
      <div>
        <div class="total-label">Estimated Total</div>
        <div class="total-amount" id="total-display">R0.00</div>
        <div id="rush-fee-display" style="display: none; font-size: 0.85rem; color: #e63946; margin-top: 0.25rem;"></div>
      </div>
      <button type="submit" class="btn btn-primary" style="padding: 0.8rem 2.5rem; font-size: 1.1rem;">Request Quote</button>
    </div>

  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', updateTotal);

  function toggleCard(card) {
    const checkbox = card.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    updateTotal();
  }

  function updateTotal() {
    const checkboxes = document.querySelectorAll('input[name="packages"]');
    const timelineSelect = document.getElementById('id_timeline');
    const rushWarning = document.getElementById('rush-warning');
    const rushFeeDisplay = document.getElementById('rush-fee-display');
    
    let subtotal = 0;
    let anyChecked = false;

    checkboxes.forEach(cb => {
      const card = cb.closest('.package-card');
      if (cb.checked) {
        subtotal += parseFloat(cb.dataset.price);
        card.classList.add('selected');
        anyChecked = true;
      } else {
        card.classList.remove('selected');
      }
    });

    // Check if rush timeline is selected
    const isRush = timelineSelect && timelineSelect.value === 'rush';
    let rushFee = 0;
    let total = subtotal;
    
    if (isRush && subtotal > 0) {
      rushFee = subtotal * 0.50; // 50% rush fee
      total = subtotal + rushFee;
      rushWarning.style.display = 'block';
      rushFeeDisplay.style.display = 'block';
      rushFeeDisplay.textContent = `Includes R${rushFee.toFixed(2)} rush fee`;
    } else {
      rushWarning.style.display = 'none';
      rushFeeDisplay.style.display = 'none';
    }

    document.getElementById('total-display').textContent = 'R' + total.toFixed(2);
    
    const footer = document.getElementById('sticky-footer');
    if (anyChecked) {
      footer.classList.add('visible');
    } else {
      footer.classList.remove('visible');
    }
  }

  function showFilePreview(input) {
    const previewContainer = document.getElementById('file-preview');
    
    if (input.files && input.files.length > 0) {
      const file = input.files[0];
      const fileSize = (file.size / 1024 / 1024).toFixed(2);
      
      let previewHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1rem; background: white; border-radius: 6px; border: 1px solid #ddd;">
          <div style="width: 50px; height: 50px; background: #1d3557; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;">
            ${file.name.split('.').pop().toUpperCase()}
          </div>
          <div style="flex: 1; text-align: left;">
            <p style="margin: 0; font-weight: bold; color: #1d3557;">${file.name}</p>
            <p style="margin: 0; font-size: 0.85rem; color: #666;">${fileSize} MB</p>
          </div>
          <button type="button" onclick="clearFile()" style="background: #e63946; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Remove</button>
        </div>
      `;
      
      // Show image preview for image files
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewHTML = `
            <div style="padding: 1rem; background: white; border-radius: 6px; border: 1px solid #ddd;">
              <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 4px; margin-bottom: 0.5rem;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <p style="margin: 0; font-weight: bold; color: #1d3557;">${file.name}</p>
                  <p style="margin: 0; font-size: 0.85rem; color: #666;">${fileSize} MB</p>
                </div>
                <button type="button" onclick="clearFile()" style="background: #e63946; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Remove</button>
              </div>
            </div>
          `;
          previewContainer.innerHTML = previewHTML;
        };
        reader.readAsDataURL(file);
      } else {
        previewContainer.innerHTML = previewHTML;
      }
    } else {
      previewContainer.innerHTML = '<p id="file-name" style="color: #666; font-size: 0.9rem;">No file selected</p>';
    }
  }
  
  function clearFile() {
    const input = document.getElementById('id_upload');
    input.value = '';
    showFilePreview(input);
  }
</script>
{% endblock %}
